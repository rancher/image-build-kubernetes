---
name: "Update build base version"

sources:
  # Read the current version from the Dockerfile
  current_minor:
    name: Get current build base minor version from Dockerfile
    kind: dockerfile
    spec:
      file: Dockerfile
      instruction:
        keyword: ARG
        matcher: GO_IMAGE
    transformers:
      # Value is "rancher/hardened-build-base:v1.24.9b1"
      # Trim prefix to get "v1.24.9b1"
      - trimprefix: "rancher/hardened-build-base:"
      # Trim 'v' prefix to get "1.24.9b1"
      - trimprefix: "v"
      # This regex captures the major.minor to get "1.24"
      # but it will be a list that will be handled in the next step
      - findsubmatch:
          pattern: '^([0-9]+\.[0-9]+)'
      # Select the last element from the list
      - kind: lastelement

  # Find the latest release matching that minor version
  latest_patch:
    name: Get latest build base patch for that minor
    kind: githubrelease
    dependson:
      - "current_minor"
    spec:
      owner: rancher
      repository: image-build-base
      token: '{{ requiredEnv .github.token }}'
      typefilter:
        release: true
        draft: false
        prerelease: false
      versionfilter:
        kind: regex
        # This searches for tags "v1.24.*"
        # using the "1.24" value from the 'current_minor' source
        pattern: 'v{{ source "current_minor" }}\.\S+'

targets:
  dockerfile:
    name: "Bump to latest build base version in Dockerfile"
    kind: dockerfile
    scmid: default
    sourceid: latest_patch
    spec:
      file: Dockerfile
      instruction:
        keyword: ARG
        matcher: "GO_IMAGE"
    transformers:
      - addprefix: "rancher/hardened-build-base:"

scms:
  default:
    kind: github
    spec:
      token: '{{ requiredEnv .github.token }}'
      username: '{{ requiredEnv .github.username }}'
      user: '{{ .github.user }}'
      email: '{{ .github.email }}'
      owner: '{{ .github.owner }}'
      repository: '{{ .github.repository }}'
      branch: '{{ .github.branch }}'
      
actions:
    default:
        title: 'Bump build base version to {{ source "latest_patch" }}'
        kind: github/pullrequest
        spec:
            automerge: false
            labels:
                - chore
                - skip-changelog
                - status/auto-created
        scmid: default

